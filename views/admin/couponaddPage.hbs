<div class="p-4 md:p-8 bg-gray-200 max-w-5xl mx-auto">
    <h2 class="text-2xl md:text-3xl font-bold text-gray-700 mb-4 md:mb-6">Add New Coupon</h2>

    <!-- Add New Coupon Form -->
    <form id="couponForm" class="space-y-4 md:space-y-6" onsubmit="addCoupon(event)">
    <!-- Coupon Title -->
    <div>
        <label for="name" class="block text-sm font-medium text-gray-700">Coupon Title</label>
        <input type="text" id="name" name="name" placeholder="e.g. Summer Sale" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        <p id="nameError" class="text-sm text-red-500 mt-1 hidden">Coupon title is required.</p>
    </div>

    <!-- Coupon Description -->
    <div>
        <label for="description" class="block text-sm font-medium text-gray-700">Coupon Description</label>
        <textarea id="description" rows="3" name="description" placeholder="e.g. Get 20% off on all electronics" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
        <p id="descriptionError" class="text-sm text-red-500 mt-1 hidden">Description is required.</p>
    </div>

    <!-- Coupon Code -->
    <div>
        <label for="code" class="block text-sm font-medium text-gray-700">Coupon Code</label>
        <input type="text" id="code" name="code" placeholder="e.g. SUMMER20" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        <p id="codeError" class="text-sm text-red-500 mt-1 hidden">Coupon code is required.</p>
    </div>

    <!-- Discount Value -->
        <div>
            <label for="discountValue" class="block text-sm font-medium text-gray-700">Discount Value</label>
            <input type="number" name="discountValue" id="discountValue" placeholder="Enter the Discount Value" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
            <p id="discountValueError" class="text-sm text-red-500 mt-1 hidden">Discount value is required.</p>
        </div>

        <!--Minimum Price-->
         <div>
            <label for="minimumPrice" class="block text-sm font-medium text-gray-700">Minimum Price</label>
            <input type="number" name="minimumPrice" id="minimumPrice" placeholder="Enter the Minimum Price" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
            <p id="minimumPriceError" class="text-sm text-red-500 mt-1 hidden">Minimum Price is required.</p>
        </div>

    <!-- Expiry Dates -->
    <div class="flex flex-wrap -mx-2">
        <!-- Start Date -->
        <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
            <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
            <input type="date" id="startDate" name="startDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
            <p id="startDateError" class="text-sm text-red-500 mt-1 hidden">Start date is required.</p>
        </div>
        <!-- End Date -->
        <div class="w-full md:w-1/2 px-2">
            <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
            <input type="date" id="endDate" name="endDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
            <p id="endDateError" class="text-sm text-red-500 mt-1 hidden">End date is required.</p>
        </div>
    </div>

    <!-- Submit Button -->
    <div class="text-right">
        <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-full hover:bg-blue-600">Add Coupon</button>
    </div>
    </form>

    {{#if data}}
    <!-- Existing Coupons Section -->
    <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-4">Existing Coupons</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300">
            <thead>
                <tr class="bg-gray-200">
                    <th class="px-2 py-2 md:px-4 text-left text-xs md:text-sm text-gray-600">Coupon Title</th>
                    <th class="px-2 py-2 md:px-4 text-left text-xs md:text-sm text-gray-600">Coupon Code</th>
                    <th class="px-2 py-2 md:px-4 text-left text-xs md:text-sm text-gray-600">Discount Value</th>
                    <th class="px-2 py-2 md:px-4 text-left text-xs md:text-sm text-gray-600">Expiry</th>
                    <th class="px-2 py-2 md:px-4 text-left text-xs md:text-sm text-gray-600">Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each data}}
                <tr class="border-t border-gray-300">
                    <td class="px-2 py-2 md:px-4">{{this.name}}</td>
                    <td class="px-2 py-2 md:px-4">{{this.code}}</td>
                    <td class="px-2 py-2 md:px-4">{{this.discountValue}}</td>
                    <td class="px-2 py-2 md:px-4">{{this.startDate}}  to  {{this.endDate}}</td>
                    <td class="px-2 py-2 md:px-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                        <button onclick="editCoupon('{{this.code}}')" class="bg-yellow-500 text-white px-2 py-1 md:px-3 rounded-full hover:bg-yellow-600">Edit</button>
                        <button onclick="deleteCoupon('{{this.code}}')" class="bg-red-500 text-white px-2 py-1 md:px-3 rounded-full hover:bg-red-600">Delete</button>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="flex flex-col items-center justify-center h-64 bg-gray-100 border border-gray-300 rounded-lg shadow-sm p-6 mt-3">
  <!-- Icon -->
  <div class="bg-gray-200 rounded-full p-4 mb-4">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-10 w-10 text-gray-500"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M9 14l6-6m0 0l-6-6m6 6H3m15 10h2a2 2 0 002-2v-3a2 2 0 00-2-2h-2m0 7v-7m0 7h-6m-6 0H5a2 2 0 01-2-2v-3a2 2 0 012-2h6"
      />
    </svg>
  </div>

  <!-- Text -->
  <h2 class="text-lg font-medium text-gray-700 mb-1">No Coupons Found</h2>
  <p class="text-sm text-gray-500 mb-4">
    There are currently no coupons added. You can create a new one.
  </p>

  <!-- Button -->
  <button
    class="px-5 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
    onclick="location.href='/admin/addcoupon'"
  >
    Add New Coupon
  </button>
</div>
{{/if}}
</div>

<script>
    function addCoupon(e){

        e.preventDefault();

        let isValid=true

        const couponName=document.getElementById("name").value
        const description=document.getElementById("description").value
        const couponCode=document.getElementById("code").value
        const startDate=document.getElementById("startDate").value
        const endDate=document.getElementById("endDate").value
        const discountValue=document.getElementById("discountValue").value
        const minimumPrice=document.getElementById("minimumPrice").value
        const currentDate=new Date()
        const formattedDate=new Date(currentDate.toISOString().split('T')[0])

        if(!couponCode && !description && !couponName && !startDate && !endDate && !discountValue && !minimumPrice){
            isValid=false
            Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please fill out all fields!',
        });
        }else{
        if(!couponName){
            document.getElementById("nameError").classList.remove('hidden')
            isValid=false
        }
        if(!/^[a-zA-Z\s]+$/.test(couponName)){
            document.getElementById("nameError").innerText="Only Alphabet is allowed no other character"
            document.getElementById("nameError").classList.remove('hidden')
            isValid=false
        }
        if(!description){
             document.getElementById("descriptionError").classList.remove('hidden')
             isValid=false
        }
        if(!couponCode){
             document.getElementById("codeError").classList.remove('hidden')
             isValid=false
        }
        if(!discountValue){
             document.getElementById("discountValueError").classList.remove('hidden')
             isValid=false
        }
        if(discountValue>3000){
             document.getElementById("discountValueError").innerText="Discount value cannot be greater than 3000"
             document.getElementById("discountValueError").classList.remove('hidden')
             isValid=false
        }
        if(minimumPrice<0 || minimumPrice==0){
            document.getElementById("minimumPriceError").innerText="Minimum price cannot be zero or negative"
            document.getElementById("minimumPriceError").classList.remove('hidden')
            isValid=false
        }
        if(discountValue<0 || discountValue==0){
            document.getElementById("discountValueError").innerText="Discount value cannot be zero or negative"
            document.getElementById("discountValueError").classList.remove('hidden')
            isValid=false
        }
        if(parseInt(minimumPrice)<parseInt(discountValue)){
             document.getElementById("minimumPriceError").innerText="Minimum price cannot be less than Discount value"
             document.getElementById("minimumPriceError").classList.remove('hidden')
             isValid=false
        }
        if(!startDate){
             document.getElementById("startDateError").classList.remove('hidden')
             isValid=false
        }
        if(!endDate){
             document.getElementById("endDateError").classList.remove('hidden')
             isValid=false
        }
        if(!minimumPrice){
            document.getElementById("minimumPriceError").classList.remove('hidden')
            isValid=false
        }
        if(new Date(startDate) > new Date(endDate)){
             Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'End date cannot be less than start date',
        });
        isValid=false
        }
        if(new Date(startDate)< formattedDate || new Date(endDate)< formattedDate){
            Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Cannot take the older dates',
        });
        isValid=false
        }
        }

        if(isValid){
            fetch('/admin/addcoupon',{
                headers:{
                    'Content-Type':"application/json"
                },
                method:"POST",
                body:JSON.stringify({
                    name:couponName,
                    description:description,
                    code:couponCode,
                    discountValue:discountValue,
                    startDate:startDate,
                    endDate:endDate,
                    minimumPrice:minimumPrice
                })
            }).then((response)=>response.json()).then((response)=>{
                if(response.status){
                    Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text:response.message,
                    confirmButtonText: 'OK',
                    }).then(()=>{
                        location.href='/admin/coupon'
                    })

                }else{
                    Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text:response.message,
                    confirmButtonText: 'Retry',
                    }).then(()=>{
                        location.reload();
                    })

                }
            })
        }
    }

    function editCoupon(couponCode){
        location.href=`/admin/editcoupon/${couponCode}`
    }

    function deleteCoupon(couponCode){
        Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "Cancel",
      }).then((result) => {
        if (result.isConfirmed) {
        fetch(`/admin/deletecoupon/${couponCode}`,{
        method:'POST'
        }).then((response)=>response.json()).then((response)=>{
            if(response.status){
                 Swal.fire({
                icon: "success",
                title: "Success!",
                text:response.message,
                confirmButtonColor: "#3085d6",
            }).then(()=>{
                location.reload();
            })
            }else{
                Swal.fire({
                icon: "error",
                title: "Error!",
                text:response.message,
                confirmButtonColor: "#d33",
            })
            }
        }).catch(()=>{
            Swal.fire({
            icon: "error",
            title: "Error!",
            text: "Something went wrong. Please try again.",
            confirmButtonColor: "#d33",
            })
        })
        }
      })
    }
</script>
